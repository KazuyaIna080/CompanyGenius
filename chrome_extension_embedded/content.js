// CompanyGenius Embedded - Content Script
// Âè≥„ÇØ„É™„ÉÉ„ÇØ„É°„Éã„É•„Éº„Å®„Éö„Éº„Ç∏ÂÜÖ„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥

class EmbeddedContent {
    constructor() {
        this.currentDialog = null;
        this.init();
    }
    
    init() {
        console.log('üîó CompanyGenius Embedded content script loaded for:', window.location.hostname);
        
        // „É°„ÉÉ„Çª„Éº„Ç∏„É™„Çπ„Éä„ÉºË®≠ÂÆö
        chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
            this.handleMessage(message, sender, sendResponse);
            return true; // ÈùûÂêåÊúü„É¨„Çπ„Éù„É≥„Çπ
        });
    }
    
    async handleMessage(message, sender, sendResponse) {
        try {
            switch (message.action) {
                case 'showPredictionDialog':
                    await this.showPredictionDialog(message.query, message.result);
                    sendResponse({ success: true });
                    break;
                    
                default:
                    sendResponse({ error: 'Unknown action' });
            }
        } catch (error) {
            console.error('Content script error:', error);
            sendResponse({ error: error.message });
        }
    }
    
    async showPredictionDialog(query, result) {
        // Êó¢Â≠ò„ÅÆ„ÉÄ„Ç§„Ç¢„É≠„Ç∞„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
        this.removePredictionDialog();
        
        // „ÉÄ„Ç§„Ç¢„É≠„Ç∞‰ΩúÊàê
        const dialog = this.createPredictionDialog(query, result);
        document.body.appendChild(dialog);
        
        this.currentDialog = dialog;
        
        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        requestAnimationFrame(() => {
            dialog.classList.add('show');
        });
        
        // Ëá™Âãï„ÇØ„É≠„Éº„Ç∫„Çø„Ç§„Éû„ÉºÔºà10ÁßíÔºâ
        setTimeout(() => {
            this.removePredictionDialog();
        }, 10000);
    }
    
    createPredictionDialog(query, result) {
        const dialog = document.createElement('div');
        dialog.className = 'companygenius-dialog';
        dialog.innerHTML = `
            <div class="companygenius-dialog-content">
                <div class="companygenius-header">
                    <span class="companygenius-icon">${this.getSourceIcon(result.source)}</span>
                    <span class="companygenius-title">CompanyGenius</span>
                    <button class="companygenius-close">&times;</button>
                </div>
                
                <div class="companygenius-body">
                    <div class="companygenius-query">
                        <strong>Ê§úÁ¥¢:</strong> "${query}"
                    </div>
                    
                    <div class="companygenius-result">
                        <div class="companygenius-company-name">${result.prediction}</div>
                        <div class="companygenius-details">
                            <div>‰ø°È†ºÂ∫¶: ${(result.confidence * 100).toFixed(0)}%</div>
                            <div>„ÇΩ„Éº„Çπ: ${this.getSourceLabel(result.source)}</div>
                            ${result.securities_code ? `<div>Ë®ºÂà∏„Ç≥„Éº„Éâ: ${result.securities_code}</div>` : ''}
                        </div>
                    </div>
                    
                    ${result.alternatives ? this.renderAlternatives(result.alternatives) : ''}
                    
                    <div class="companygenius-actions">
                        <button class="companygenius-btn companygenius-correct-btn" data-action="correct">
                            ‚ùå ÈñìÈÅï„ÅÑ
                        </button>
                        <button class="companygenius-btn companygenius-accept-btn" data-action="accept">
                            ‚úÖ Ê≠£Ëß£
                        </button>
                    </div>
                    
                    ${result.note ? `<div class="companygenius-note">üìù ${result.note}</div>` : ''}
                </div>
            </div>
        `;
        
        // „Çπ„Çø„Ç§„É´ËøΩÂä†
        this.addDialogStyles();
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        this.setupDialogEventListeners(dialog, query, result);
        
        return dialog;
    }
    
    renderAlternatives(alternatives) {
        if (!alternatives || alternatives.length === 0) return '';
        
        const altHtml = alternatives.map(alt => 
            `<div class="companygenius-alternative">
                üìã ${alt.name} ${alt.code ? `(${alt.code})` : ''}
            </div>`
        ).join('');
        
        return `
            <div class="companygenius-alternatives">
                <div class="companygenius-alternatives-title">„Åù„ÅÆ‰ªñ„ÅÆÂÄôË£ú:</div>
                ${altHtml}
            </div>
        `;
    }
    
    setupDialogEventListeners(dialog, query, result) {
        // Èñâ„Åò„Çã„Éú„Çø„É≥
        dialog.querySelector('.companygenius-close').addEventListener('click', () => {
            this.removePredictionDialog();
        });
        
        // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥
        dialog.querySelectorAll('.companygenius-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const action = e.target.dataset.action;
                
                if (action === 'correct') {
                    await this.handleCorrection(query, result);
                } else if (action === 'accept') {
                    this.handleAccept();
                }
                
                this.removePredictionDialog();
            });
        });
        
        // Â§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        dialog.addEventListener('click', (e) => {
            if (e.target === dialog) {
                this.removePredictionDialog();
            }
        });
    }
    
    async handleCorrection(query, result) {
        const correctName = prompt(
            `Ê≠£„Åó„ÅÑ‰ºÅÊ•≠Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:\n\n` +
            `Ê§úÁ¥¢Ë™û: ${query}\n` +
            `‰∫àÊ∏¨ÁµêÊûú: ${result.prediction}\n\n` +
            `Ê≠£Ëß£:`
        );
        
        if (correctName && correctName.trim() && correctName.trim() !== result.prediction) {
            try {
                await this.sendMessage({
                    action: 'correct',
                    originalQuery: query,
                    predictedName: result.prediction,
                    correctName: correctName.trim()
                });
                
                this.showNotification('‚úÖ Â≠¶Áøí„Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                
            } catch (error) {
                console.error('Correction error:', error);
                this.showNotification('‚ùå Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
    }
    
    handleAccept() {
        this.showNotification('‚úÖ „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ', 'success');
    }
    
    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `companygenius-notification companygenius-notification-${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        requestAnimationFrame(() => {
            notification.classList.add('show');
        });
        
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
    
    removePredictionDialog() {
        if (this.currentDialog) {
            this.currentDialog.classList.remove('show');
            setTimeout(() => {
                if (this.currentDialog && this.currentDialog.parentNode) {
                    this.currentDialog.parentNode.removeChild(this.currentDialog);
                }
                this.currentDialog = null;
            }, 300);
        }
    }
    
    addDialogStyles() {
        // „Çπ„Çø„Ç§„É´„ÅåÊó¢„Å´ËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Çå„Å∞‰Ωï„ÇÇ„Åó„Å™„ÅÑ
        if (document.getElementById('companygenius-styles')) return;
        
        const styles = document.createElement('style');
        styles.id = 'companygenius-styles';
        styles.textContent = `
            .companygenius-dialog {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .companygenius-dialog.show {
                opacity: 1;
            }
            
            .companygenius-dialog-content {
                background: white;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                max-width: 400px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                transform: scale(0.9);
                transition: transform 0.3s ease;
            }
            
            .companygenius-dialog.show .companygenius-dialog-content {
                transform: scale(1);
            }
            
            .companygenius-header {
                display: flex;
                align-items: center;
                padding: 16px 20px;
                border-bottom: 1px solid #eee;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 12px 12px 0 0;
            }
            
            .companygenius-icon {
                font-size: 20px;
                margin-right: 8px;
            }
            
            .companygenius-title {
                font-weight: 600;
                flex: 1;
            }
            
            .companygenius-close {
                background: none;
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background 0.2s ease;
            }
            
            .companygenius-close:hover {
                background: rgba(255, 255, 255, 0.2);
            }
            
            .companygenius-body {
                padding: 20px;
                color: #333;
            }
            
            .companygenius-query {
                margin-bottom: 16px;
                font-size: 14px;
                color: #666;
            }
            
            .companygenius-result {
                margin-bottom: 16px;
            }
            
            .companygenius-company-name {
                font-size: 18px;
                font-weight: 700;
                color: #333;
                margin-bottom: 8px;
                padding: 12px;
                background: #f8f9fa;
                border-radius: 8px;
                border-left: 4px solid #667eea;
            }
            
            .companygenius-details {
                font-size: 13px;
                color: #666;
            }
            
            .companygenius-details div {
                margin-bottom: 4px;
            }
            
            .companygenius-alternatives {
                margin-bottom: 16px;
                padding: 12px;
                background: #f1f3f4;
                border-radius: 8px;
            }
            
            .companygenius-alternatives-title {
                font-size: 12px;
                font-weight: 600;
                margin-bottom: 8px;
                color: #5f6368;
            }
            
            .companygenius-alternative {
                font-size: 12px;
                color: #666;
                margin-bottom: 4px;
                padding-left: 8px;
            }
            
            .companygenius-actions {
                display: flex;
                gap: 8px;
                margin-bottom: 16px;
            }
            
            .companygenius-btn {
                flex: 1;
                padding: 10px 16px;
                border: none;
                border-radius: 6px;
                font-size: 13px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .companygenius-correct-btn {
                background: #ff6b6b;
                color: white;
            }
            
            .companygenius-correct-btn:hover {
                background: #ff5252;
            }
            
            .companygenius-accept-btn {
                background: #51cf66;
                color: white;
            }
            
            .companygenius-accept-btn:hover {
                background: #40c057;
            }
            
            .companygenius-note {
                font-size: 12px;
                color: #666;
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 6px;
                padding: 8px;
            }
            
            .companygenius-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                border-radius: 8px;
                padding: 12px 16px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                z-index: 10001;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-size: 14px;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            }
            
            .companygenius-notification.show {
                opacity: 1;
                transform: translateX(0);
            }
            
            .companygenius-notification-success {
                border-left: 4px solid #51cf66;
            }
            
            .companygenius-notification-error {
                border-left: 4px solid #ff6b6b;
            }
        `;
        
        document.head.appendChild(styles);
    }
    
    getSourceLabel(source) {
        const labels = {
            'user_learning': 'üß† „É¶„Éº„Ç∂„ÉºÂ≠¶Áøí',
            'edinet_exact': 'üéØ EDINETÂÆåÂÖ®‰∏ÄËá¥',
            'edinet_partial': 'üîç EDINETÈÉ®ÂàÜ‰∏ÄËá¥',
            'estimation': 'üí≠ Êé®ÂÆö'
        };
        return labels[source] || source;
    }
    
    getSourceIcon(source) {
        const icons = {
            'user_learning': 'üß†',
            'edinet_exact': 'üéØ',
            'edinet_partial': 'üîç',
            'estimation': 'üí≠'
        };
        return icons[source] || 'üè¢';
    }
    
    // ChromeÊã°ÂºµÊ©üËÉΩ„É°„ÉÉ„Çª„Éº„Ç∏„É≥„Ç∞
    sendMessage(message) {
        return new Promise((resolve, reject) => {
            chrome.runtime.sendMessage(message, (response) => {
                if (chrome.runtime.lastError) {
                    reject(new Error(chrome.runtime.lastError.message));
                } else if (response && response.error) {
                    reject(new Error(response.error));
                } else {
                    resolve(response);
                }
            });
        });
    }
}

// „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çπ„ÇØ„É™„Éó„ÉàÂàùÊúüÂåñ
new EmbeddedContent();

console.log('üîó CompanyGenius Embedded content script initialized');